(function(K,v){"function"===typeof define&&define.amd?define(["exports"],v):"object"===typeof exports&&"string"!==typeof exports.nodeName?v(exports):v(K.commonJsStrict={})})(this,function(K){function v(a){if(a in P)return a;for(var c=a[0].toUpperCase()+a.slice(1),b=Q.length;b--;)if(a=Q[b]+c,a in P)return a}function y(a,c){a=a||{};for(var b in c)c[b]&&c[b].constructor&&c[b].constructor===Object?(a[b]=a[b]||{},y(a[b],c[b])):a[b]=c[b];return a}function L(a){if("createEvent"in document){var c=document.createEvent("HTMLEvents");
c.initEvent("change",!1,!0);a.dispatchEvent(c)}else a.fireEvent("onchange")}function p(a,c,b){if("string"===typeof c){var d=c;c={};c[d]=b}for(var f in c)a.style[f]=c[f]}function r(a,c){a.classList?a.classList.add(c):a.className+=" "+c}function U(a,c){var b=c||new Image;if(b.src===a)var d=new Promise(function(a,c){a(b)});else d=new Promise(function(c,d){"http"===a.substring(0,4).toLowerCase()&&b.setAttribute("crossOrigin","anonymous");b.onload=function(){setTimeout(function(){c(b)},1)}}),b.src=a;b.style.opacity=
0;return d}function V(a,c){window.EXIF||c(0);EXIF.getData(a,function(){var a=EXIF.getTag(this,"Orientation");c(a)})}function G(a,c,b){var d=c.width,f=c.height,e=a.getContext("2d");a.width=c.width;a.height=c.height;e.save();switch(b){case 2:e.translate(d,0);e.scale(-1,1);break;case 3:e.translate(d,f);e.rotate(180*Math.PI/180);break;case 4:e.translate(0,f);e.scale(1,-1);break;case 5:a.width=f;a.height=d;e.rotate(90*Math.PI/180);e.scale(1,-1);break;case 6:a.width=f;a.height=d;e.rotate(90*Math.PI/180);
e.translate(0,-f);break;case 7:a.width=f;a.height=d;e.rotate(-90*Math.PI/180);e.translate(-d,f);e.scale(1,-1);break;case 8:a.width=f,a.height=d,e.translate(0,d),e.rotate(-90*Math.PI/180)}e.drawImage(c,0,0,d,f);e.restore()}function C(a){if(this.options.enableZoom){var c=this.elements.zoomer;a=w(a,4);c.value=Math.max(c.min,Math.min(c.max,a))}}function W(){function a(){R.call(b,{value:parseFloat(f.value),origin:new D(b.elements.preview),viewportRect:b.elements.viewport.getBoundingClientRect(),transform:h.parse(b.elements.preview)})}
function c(c){var d=b._currentZoom+(c.wheelDelta?c.wheelDelta/1200:c.deltaY?c.deltaY/1060:c.detail?c.detail/-60:0);c.preventDefault();C.call(b,d);a.call(b)}var b=this,d=b.elements.zoomerWrap=document.createElement("div"),f=b.elements.zoomer=document.createElement("input");r(d,"cr-slider-wrap");r(f,"cr-slider");f.type="range";f.step="0.0001";f.value=1;f.style.display=b.options.showZoomer?"":"none";b.element.appendChild(d);d.appendChild(f);b._currentZoom=1;b.elements.zoomer.addEventListener("input",
a);b.elements.zoomer.addEventListener("change",a);b.options.mouseWheelZoom&&(b.elements.boundary.addEventListener("mousewheel",c),b.elements.boundary.addEventListener("DOMMouseScroll",c))}function R(a){function c(){var a={};a[n]=d.toString();a[z]=e.toString();p(b.elements.preview,a)}var b=this,d=a?a.transform:h.parse(b.elements.preview),f=a?a.viewportRect:b.elements.viewport.getBoundingClientRect(),e=a?a.origin:new D(b.elements.preview);b._currentZoom=a?a.value:b._currentZoom;d.scale=b._currentZoom;
c();b.options.enforceBoundary&&(f=X.call(b,f),a=f.translate,f=f.origin,d.x>=a.maxX&&(e.x=f.minX,d.x=a.maxX),d.x<=a.minX&&(e.x=f.maxX,d.x=a.minX),d.y>=a.maxY&&(e.y=f.minY,d.y=a.maxY),d.y<=a.minY&&(e.y=f.maxY,d.y=a.minY));c();Y.call(b);E.call(b)}function X(a){var c=this._currentZoom,b=a.width;a=a.height;var d=this.options.boundary.width/2,f=this.options.boundary.height/2,e=this.elements.preview.getBoundingClientRect(),g=e.width;e=e.height;var k=b/2,l=a/2;d=-1*(k/c-d);f=-1*(l/c-f);k*=1/c;l*=1/c;return{translate:{maxX:d,
minX:d-(1/c*g-1/c*b),maxY:f,minY:f-(1/c*e-1/c*a)},origin:{maxX:1/c*g-k,minX:k,maxY:1/c*e-l,minY:l}}}function M(){var a=this._currentZoom,c=this.elements.preview.getBoundingClientRect(),b=this.elements.viewport.getBoundingClientRect(),d=h.parse(this.elements.preview.style[n]),f=new D(this.elements.preview),e=b.left-c.left+b.width/2;c=(b.top-c.top+b.height/2)/a;e/=a;b=(c-f.y)*(1-a);d.x-=(e-f.x)*(1-a);d.y-=b;a={};a[z]=e+"px "+c+"px";a[n]=d.toString();p(this.elements.preview,a)}function Z(){function a(a,
b){var c=e.elements.preview.getBoundingClientRect(),d=m.y+b,H=m.x+a;e.options.enforceBoundary?(A.top>c.top+b&&A.bottom<c.bottom+b&&(m.y=d),A.left>c.left+a&&A.right<c.right+a&&(m.x=H)):(m.y=d,m.x=H)}function c(b){var c={};a(b[0],b[1]);c[n]=m.toString();p(e.elements.preview,c);I.call(e);document.body.style[J]="";M.call(e);E.call(e);u=0}function b(a){a.preventDefault();g||(g=!0,k=a.pageX,l=a.pageY,a.touches&&(a=a.touches[0],k=a.pageX,l=a.pageY),m=h.parse(e.elements.preview),window.addEventListener("mousemove",
d),window.addEventListener("touchmove",d),window.addEventListener("mouseup",f),window.addEventListener("touchend",f),document.body.style[J]="none",A=e.elements.viewport.getBoundingClientRect())}function d(b){b.preventDefault();var c=b.pageX,d=b.pageY;b.touches&&(d=b.touches[0],c=d.pageX,d=d.pageY);var f=c-k,H=d-l,g={};"touchmove"==b.type&&1<b.touches.length?(c=b.touches[0],b=b.touches[1],b=Math.sqrt((c.pageX-b.pageX)*(c.pageX-b.pageX)+(c.pageY-b.pageY)*(c.pageY-b.pageY)),u||(u=b/e._currentZoom),C.call(e,
b/u),L(e.elements.zoomer)):(a(f,H),g[n]=m.toString(),p(e.elements.preview,g),I.call(e),l=d,k=c)}function f(){g=!1;window.removeEventListener("mousemove",d);window.removeEventListener("touchmove",d);window.removeEventListener("mouseup",f);window.removeEventListener("touchend",f);document.body.style[J]="";M.call(e);E.call(e);u=0}var e=this,g=!1,k,l,u,A,m;e.elements.overlay.addEventListener("mousedown",b);e.elements.viewport.addEventListener("keydown",function(a){function b(a){switch(a){case 37:return[1,
0];case 38:return[0,1];case 39:return[-1,0];case 40:return[0,-1]}}if(!a.shiftKey||38!=a.keyCode&&40!=a.keyCode)37<=a.keyCode&&40>=a.keyCode&&(a.preventDefault(),a=b(a.keyCode),m=h.parse(e.elements.preview),document.body.style[J]="none",A=e.elements.viewport.getBoundingClientRect(),c(a));else{var d=0;d=38==a.keyCode?parseFloat(e.elements.zoomer.value,10)+parseFloat(e.elements.zoomer.step,10):parseFloat(e.elements.zoomer.value,10)-parseFloat(e.elements.zoomer.step,10);e.setZoom(d)}});e.elements.overlay.addEventListener("touchstart",
b)}function I(){var a=this.elements.boundary.getBoundingClientRect(),c=this.elements.preview.getBoundingClientRect();p(this.elements.overlay,{width:c.width+"px",height:c.height+"px",top:c.top-a.top+"px",left:c.left-a.left+"px"})}function E(){var a=this.get();if(0<this.elements.preview.offsetHeight&&0<this.elements.preview.offsetWidth)if(this.options.update.call(this,a),this.$)this.$(this.element).trigger("update",a);else{if(window.CustomEvent)var c=new CustomEvent("update",{detail:a});else c=document.createEvent("CustomEvent"),
c.initCustomEvent("update",!0,!0,a);this.element.dispatchEvent(c)}}function O(){var a=0,c=1.5,b=1,d={},f=this.elements.preview,e=this.elements.zoomer,g=new h(0,0,b),k=new D;if(0<this.elements.preview.offsetHeight&&0<this.elements.preview.offsetWidth&&!this.data.bound){this.data.bound=!0;d[n]=g.toString();d[z]=k.toString();d.opacity=1;p(f,d);k=f.getBoundingClientRect();var l=this.elements.viewport.getBoundingClientRect();var u=this.elements.boundary.getBoundingClientRect();this._originalImageWidth=
k.width;this._originalImageHeight=k.height;this.options.enableZoom?(this.options.enforceBoundary&&(a=l.width/k.width,b=l.height/k.height,a=Math.max(a,b)),a>=c&&(c=a+1),e.min=w(a,4),e.max=w(c,4),c=Math.max(u.width/k.width,u.height/k.height),b=null!==this.data.boundZoom?this.data.boundZoom:c,C.call(this,b),L(e)):this._currentZoom=b;g.scale=this._currentZoom;d[n]=g.toString();p(f,d);if(this.data.points.length){d=this.data.points;if(4!=d.length)throw"Croppie - Invalid number of points supplied: "+d;f=
d[2]-d[0];g=this.elements.viewport.getBoundingClientRect();c=this.elements.boundary.getBoundingClientRect();f=g.width/f;e=-1*d[1]+(g.top-c.top);g=-1*d[0]+(g.left-c.left);c={};c[z]=d[0]+"px "+d[1]+"px";c[n]=(new h(g,e,f)).toString();p(this.elements.preview,c);C.call(this,f);this._currentZoom=f}else d=this.elements.preview.getBoundingClientRect(),f=this.elements.viewport.getBoundingClientRect(),e=this.elements.boundary.getBoundingClientRect(),d=new h(f.left-e.left-(d.width-f.width)/2,f.top-e.top-(d.height-
f.height)/2,this._currentZoom),p(this.elements.preview,n,d.toString());M.call(this);I.call(this)}}function ba(a){var c=this.elements.canvas,b=this.elements.img,d=c.getContext("2d"),f=this.options.enableExif&&window.EXIF;a=this.options.enableOrientation&&a;d.clearRect(0,0,c.width,c.height);c.width=b.width;c.height=b.height;f?V(b,function(d){G(c,b,parseInt(d));a&&G(c,b,a)}):a&&G(c,b,a)}function S(a,c){var b=this,d=[],f=null;if("string"===typeof a){var e=a;a={}}else if(Array.isArray(a))d=a.slice();else{if("undefined"==
typeof a&&b.data.url)return O.call(b),E.call(b),null;e=a.url;d=a.points||[];f="undefined"===typeof a.zoom?null:a.zoom}b.data.bound=!1;b.data.url=e||b.data.url;b.data.points=(d||b.data.points).map(function(a){return parseFloat(a)});b.data.boundZoom=f;e=U(e,b.elements.img);e.then(function(){b.options.useCanvas&&(b.elements.img.exifdata=null,ba.call(b,a.orientation||1));O.call(b);E.call(b);c&&c()});return e}function w(a,c){return parseFloat(a).toFixed(c||0)}function T(){var a=this.elements.preview.getBoundingClientRect(),
c=this.elements.viewport.getBoundingClientRect(),b=c.left-a.left;a=c.top-a.top;var d=b+this.elements.viewport.offsetWidth+(c.width-this.elements.viewport.offsetWidth)/2;c=a+this.elements.viewport.offsetHeight+(c.height-this.elements.viewport.offsetHeight)/2;var f=this._currentZoom;if(Infinity===f||isNaN(f))f=1;var e=this.options.enforceBoundary?0:Number.NEGATIVE_INFINITY;b=Math.max(e,b/f);a=Math.max(e,a/f);d=Math.max(e,d/f);c=Math.max(e,c/f);return{points:[w(b),w(a),w(d),w(c)],zoom:f}}function ca(a){var c=
this,b=T.call(c),d=y(da,y({},a)),f="string"===typeof a?a:d.type||"viewport";a=d.size;var e=d.format,g=d.quality,k=d.backgroundColor;d="boolean"===typeof d.circle?d.circle:"circle"===c.options.viewport.type;var l=c.elements.viewport.getBoundingClientRect(),h=l.width/l.height;"viewport"===a?(b.outputWidth=l.width,b.outputHeight=l.height):"object"===typeof a&&(a.width&&a.height?(b.outputWidth=a.width,b.outputHeight=a.height):a.width?(b.outputWidth=a.width,b.outputHeight=a.width/h):a.height&&(b.outputWidth=
a.height*h,b.outputHeight=a.height));-1<ea.indexOf(e)&&(b.format="image/"+e,b.quality=g);b.circle=d;b.url=c.data.url;b.backgroundColor=k;return new Promise(function(a,d){if("canvas"===f){var e=c.elements.preview;var q=b.points,g=q[0],F=q[1],k=q[2]-q[0];q=q[3]-q[1];var l=b.circle,h=document.createElement("canvas"),t=h.getContext("2d"),m=k,n=q;b.outputWidth&&b.outputHeight&&(m=b.outputWidth,n=b.outputHeight);h.width=m;h.height=n;b.backgroundColor&&(t.fillStyle=b.backgroundColor,t.fillRect(0,0,m,n));
t.drawImage(e,g,F,k,q,0,0,m,n);l&&(t.fillStyle="#fff",t.globalCompositeOperation="destination-in",t.beginPath(),t.arc(m/2,n/2,m/2,0,2*Math.PI,!0),t.closePath(),t.fill());e=h.toDataURL(b.format,b.quality);a(e)}else e=b.points,g=document.createElement("div"),F=document.createElement("img"),k=e[2]-e[0],q=e[3]-e[1],r(g,"croppie-result"),g.appendChild(F),p(F,{left:-1*e[0]+"px",top:-1*e[1]+"px"}),F.src=b.url,p(g,{width:k+"px",height:q+"px"}),a(g)})}function B(a,c){this.element=a;this.options=y(y({},B.defaults),
c);var b=this.options.viewport.type?"cr-vp-"+this.options.viewport.type:null;this.options.useCanvas=this.options.enableOrientation||this.options.enableExif&&window.EXIF;this.data={};this.elements={};var d=this.elements.boundary=document.createElement("div");var f=this.elements.viewport=document.createElement("div");this.elements.img=document.createElement("img");var e=this.elements.overlay=document.createElement("div");this.options.useCanvas?(this.elements.canvas=document.createElement("canvas"),
this.elements.preview=this.elements.canvas):this.elements.preview=this.elements.img;r(d,"cr-boundary");p(d,{width:this.options.boundary.width+"px",height:this.options.boundary.height+"px"});r(f,"cr-viewport");b&&r(f,b);p(f,{width:this.options.viewport.width+"px",height:this.options.viewport.height+"px"});f.setAttribute("tabindex",0);r(this.elements.preview,"cr-image");r(e,"cr-overlay");this.element.appendChild(d);d.appendChild(this.elements.preview);d.appendChild(f);d.appendChild(e);r(this.element,
"croppie-container");this.options.customClass&&r(this.element,this.options.customClass);Z.call(this);this.options.enableZoom&&W.call(this);this.options.url&&(b={url:this.options.url,points:this.options.points},delete this.options.url,delete this.options.points,S.call(this,b))}"function"!==typeof Promise&&!function(a){function c(a,b){return function(){a.apply(b,arguments)}}function b(a){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof a)throw new TypeError("not a function");
this._value=this._state=null;this._deferreds=[];h(a,c(f,this),c(e,this))}function d(a){var b=this;return null===this._state?void this._deferreds.push(a):void p(function(){var c=b._state?a.onFulfilled:a.onRejected;if(null===c)return void(b._state?a.resolve:a.reject)(b._value);try{var d=c(b._value)}catch(N){return void a.reject(N)}a.resolve(d)})}function f(a){try{if(a===this)throw new TypeError("A promise cannot be resolved with itself.");if(a&&("object"==typeof a||"function"==typeof a)){var b=a.then;
if("function"==typeof b)return void h(c(b,a),c(f,this),c(e,this))}this._state=!0;this._value=a;g.call(this)}catch(aa){e.call(this,aa)}}function e(a){this._state=!1;this._value=a;g.call(this)}function g(){for(var a=0,b=this._deferreds.length;b>a;a++)d.call(this,this._deferreds[a]);this._deferreds=null}function k(a,b,c,d){this.onFulfilled="function"==typeof a?a:null;this.onRejected="function"==typeof b?b:null;this.resolve=c;this.reject=d}function h(a,b,c){var d=!1;try{a(function(a){d||(d=!0,b(a))},
function(a){d||(d=!0,c(a))})}catch(N){d||(d=!0,c(N))}}var n=setTimeout,p="function"==typeof setImmediate&&setImmediate||function(a){n(a,1)},m=Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)};b.prototype["catch"]=function(a){return this.then(null,a)};b.prototype.then=function(a,c){var e=this;return new b(function(b,f){d.call(e,new k(a,c,b,f))})};b.all=function(){var a=Array.prototype.slice.call(1===arguments.length&&m(arguments[0])?arguments[0]:arguments);return new b(function(b,
c){function d(f,g){try{if(g&&("object"==typeof g||"function"==typeof g)){var h=g.then;if("function"==typeof h)return void h.call(g,function(a){d(f,a)},c)}a[f]=g;0===--e&&b(a)}catch(fa){c(fa)}}if(0===a.length)return b([]);for(var e=a.length,f=0;f<a.length;f++)d(f,a[f])})};b.resolve=function(a){return a&&"object"==typeof a&&a.constructor===b?a:new b(function(b){b(a)})};b.reject=function(a){return new b(function(b,c){c(a)})};b.race=function(a){return new b(function(b,c){for(var d=0,e=a.length;e>d;d++)a[d].then(b,
c)})};b._setImmediateFn=function(a){p=a};"undefined"!=typeof module&&module.exports?module.exports=b:a.Promise||(a.Promise=b)}(this);"function"!==typeof window.CustomEvent&&function(){function a(a,b){b=b||{bubbles:!1,cancelable:!1,detail:void 0};var c=document.createEvent("CustomEvent");c.initCustomEvent(a,b.bubbles,b.cancelable,b.detail);return c}a.prototype=window.Event.prototype;window.CustomEvent=a}();var Q=["Webkit","Moz","ms"],P=document.createElement("div").style;var n=v("transform");var z=
v("transformOrigin");var J=v("userSelect");var h=function(a,c,b){this.x=parseFloat(a);this.y=parseFloat(c);this.scale=parseFloat(b)};h.parse=function(a){return a.style?h.parse(a.style[n]):-1<a.indexOf("matrix")||-1<a.indexOf("none")?h.fromMatrix(a):h.fromString(a)};h.fromMatrix=function(a){var c=a.substring(7).split(",");c.length&&"none"!==a||(c=[1,0,0,1,0,0]);return new h(parseInt(c[4],10),parseInt(c[5],10),parseFloat(c[0]))};h.fromString=function(a){var c=a.split(") ");a=c[0].substring(12).split(",");
c=1<c.length?c[1].substring(6):1;return new h(1<a.length?a[0]:0,1<a.length?a[1]:0,c)};h.prototype.toString=function(){return"translate3d("+this.x+"px, "+this.y+"px, 0px) scale("+this.scale+")"};var D=function(a){a&&a.style[z]?(a=a.style[z].split(" "),this.x=parseFloat(a[0]),this.y=parseFloat(a[1])):this.y=this.x=0};D.prototype.toString=function(){return this.x+"px "+this.y+"px"};var Y=function(a,c,b){var d;return function(){var f=this,e=arguments,g=b&&!d;clearTimeout(d);d=setTimeout(function(){d=
null;b||a.apply(f,e)},c);g&&a.apply(f,e)}}(I,500),da={type:"canvas",format:"png",quality:1},ea=["jpeg","webp","png"];if(window.jQuery){var x=window.jQuery;x.fn.croppie=function(a){if("string"===typeof a){var c=Array.prototype.slice.call(arguments,1),b=x(this).data("croppie");return"get"===a?b.get():"result"===a?b.result.apply(b,c):"bind"===a?b.bind.apply(b,c):this.each(function(){var b=x(this).data("croppie");if(b){var f=b[a];if(x.isFunction(f))f.apply(b,c),"destroy"===a&&x(this).removeData("croppie");
else throw"Croppie "+a+" method not found";}})}return this.each(function(){var b=new B(this,a);b.$=x;x(this).data("croppie",b)})}}B.defaults={viewport:{width:100,height:100,type:"square"},boundary:{width:300,height:300},orientationControls:{enabled:!0,leftClass:"",rightClass:""},customClass:"",showZoomer:!0,enableZoom:!0,mouseWheelZoom:!0,enableExif:!1,enforceBoundary:!0,enableOrientation:!1,update:function(){}};y(B.prototype,{bind:function(a,c){return S.call(this,a,c)},get:function(){return T.call(this)},
result:function(a){return ca.call(this,a)},refresh:function(){O.call(this)},setZoom:function(a){C.call(this,a);L(this.elements.zoomer)},rotate:function(a){if(!this.options.useCanvas)throw"Croppie: Cannot rotate without enableOrientation";var c=this.elements.canvas,b=document.createElement("canvas"),d=1;b.width=c.width;b.height=c.height;b.getContext("2d").drawImage(c,0,0);if(90===a||-270===a)d=6;if(-90===a||270===a)d=8;if(180===a||-180===a)d=3;G(c,b,d);R.call(this)},destroy:function(){this.element.removeChild(this.elements.boundary);
var a=this.element;a.classList?a.classList.remove("croppie-container"):a.className=a.className.replace("croppie-container","");this.options.enableZoom&&this.element.removeChild(this.elements.zoomerWrap);delete this.elements}});K.Croppie=window.Croppie=B;"object"===typeof module&&module.exports&&(module.exports=B)});
